apiVersion: v1
kind: ConfigMap
metadata:
  name: markitos-it-html-config
  namespace: default
data:
  generate-html.sh: |
    #!/bin/sh
    # No escapamos las variables con \, dejamos que el shell las sustituya
    cat > /html/index.html <<EOF
    <!DOCTYPE html>
    <html lang="es">
    <head>
        <meta charset="UTF-8">
        <title>Markitos IT - $POD_NAME</title>
        <style>
            body { font-family: sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; display: flex; justify-content: center; align-items: center; min-height: 100vh; }
            .container { background: rgba(0,0,0,0.3); padding: 2rem; border-radius: 10px; backdrop-filter: blur(5px); }
            .value { color: #FFD700; font-family: monospace; font-weight: bold; }
        </style>
    </head>
    <body>
        <div class="container">
            <h1>üöÄ Markitos IT</h1>
            <div style="text-align: left;">
                <p>üñ•Ô∏è <b>Hostname:</b> <span class="value">$HOSTNAME</span></p>
                <p>üì¶ <b>Pod:</b> <span class="value">$POD_NAME</span></p>
                <p>üåê <b>IP:</b> <span class="value">$POD_IP</span></p>
                <p>üè∑Ô∏è <b>NS:</b> <span class="value">$POD_NAMESPACE</span></p>
                <p>üñß <b>Nodo:</b> <span class="value">$NODE_NAME</span></p>
            </div>
            <hr>
            <small>‚è∞ Generado: $(date '+%Y-%m-%d %H:%M:%S')</small>
        </div>
    </body>
    </html>
    EOF
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: markitos-it-app-website-deployment
  namespace: default
spec:
  replicas: 1
  selector:
    matchLabels:
      app: markitos-it-app-website-pods
  template:
    metadata:
      labels:
        app: markitos-it-app-website-pods
    spec:
      initContainers:
      - name: generate-html
        image: busybox:latest
        command: ['/bin/sh', '/scripts/generate-html.sh']
        env:
        - name: POD_NAME
          valueFrom:
            fieldRef:
              fieldPath: metadata.name
        - name: POD_NAMESPACE
          valueFrom:
            fieldRef:
              fieldPath: metadata.namespace
        - name: POD_IP
          valueFrom:
            fieldRef:
              fieldPath: status.podIP
        - name: NODE_NAME
          valueFrom:
            fieldRef:
              fieldPath: spec.nodeName
        volumeMounts:
        - name: html-volume
          mountPath: /html
        - name: scripts-volume
          mountPath: /scripts
      containers:
      - name: markitos-it-app-website-container
        image: nginx:latest
        ports:
        - containerPort: 80
        volumeMounts:
        - name: html-volume
          mountPath: /usr/share/nginx/html
        readinessProbe:
          httpGet:
            path: /
            port: 80
          initialDelaySeconds: 5
      volumes:
      - name: html-volume
        emptyDir: {}
      - name: scripts-volume
        configMap:
          name: markitos-it-html-config
          defaultMode: 0755
---
apiVersion: v1
kind: Service
metadata:
  name: markitos-it-app-website-service
  namespace: default
spec:
  type: ClusterIP
  selector:
    app:  markitos-it-app-website-pods
  ports:
  - port: 80
    targetPort: 80
---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: markitos-it-app-website-ingress
  namespace: default
  annotations:
    nginx.ingress.kubernetes.io/rewrite-target: /
spec:
  ingressClassName: nginx
  rules:
  - host: markitos.local
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: markitos-it-app-website-service
            port:
              number: 80